#!/bin/bash

# Apply blue deployment
echo "Deploying blue version..."
kubectl apply -f blue_deployment.yaml

# Apply green deployment
echo "Deploying green version..."
kubectl apply -f green_deployment.yaml

# Apply service (initially pointing to blue)
echo "Applying service..."
kubectl apply -f kubeservice.yaml

# Wait a few seconds for pods to be ready
sleep 5

# Check logs of green pods for errors
echo "Checking logs for green pods..."
GREEN_PODS=$(kubectl get pods -l app=messaging-app,version=green -o jsonpath="{.items[*].metadata.name}")

for pod in $GREEN_PODS
do
    echo "Logs for $pod:"
    kubectl logs $pod
done

# Optional: switch service to green for traffic
# echo "Switching service traffic to green..."
# kubectl patch service messaging-app-service -p '{"spec":{"selector":{"version":"green"}}}'
